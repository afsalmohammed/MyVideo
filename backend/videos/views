from django.http import FileResponse, Http404
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import AllowAny, IsAuthenticated
from rest_framework.response import Response
from rest_framework import status
from django.conf import settings
from .models import Video
from .serializers import VideoSerializer
from .authentication import DEMO_USERNAME, DEMO_PASSWORD, DEMO_TOKEN
import os

@api_view(["POST"])
@permission_classes([AllowAny])
def login_view(request):
    username = request.data.get("username")
    password = request.data.get("password")
    if username == DEMO_USERNAME and password == DEMO_PASSWORD:
        return Response({"token": DEMO_TOKEN}, status=status.HTTP_200_OK)
    return Response({"detail": "Invalid credentials"}, status=status.HTTP_400_BAD_REQUEST)

@api_view(["GET"])
@permission_classes([AllowAny])
def list_videos(request):
    qs = Video.objects.all().order_by("-created_at")
    return Response(VideoSerializer(qs, many=True).data)

@api_view(["GET"])
@permission_classes([AllowAny])
def video_detail(request, pk):
    try:
        video = Video.objects.get(pk=pk)
    except Video.DoesNotExist:
        raise Http404
    return Response(VideoSerializer(video).data)

@api_view(["GET"])
@permission_classes([AllowAny])
def stream_video(request, pk):
    try:
        video = Video.objects.get(pk=pk)
    except Video.DoesNotExist:
        raise Http404
    file_path = video.video_file.path
    if not os.path.exists(file_path):
        raise Http404
    response = FileResponse(open(file_path, "rb"), content_type="video/mp4")
    response["Content-Length"] = os.path.getsize(file_path)
    return response
